rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 基礎認證檢查
    function isAuthenticated() {
      return request.auth != null;
    }

    // 檢查是否為使用者本人
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // 授權使用者檢查 (用於存取共享資源)
    function isAuthorizedUser() {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active';
    }

    // 系統管理者檢查
    function isSystemAdmin() {
      return isAuthorizedUser()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // 檢查使用者是否為旅程成員
    function isTripMember(tripId) {
      return exists(/databases/$(database)/documents/trips/$(tripId)/members/$(request.auth.uid));
    }

    // 取得旅程成員角色
    function getTripMemberRole(tripId) {
      return get(/databases/$(database)/documents/trips/$(tripId)/members/$(request.auth.uid)).data.role;
    }

    // 檢查是否能編輯旅程
    function canEditTrip(tripId) {
      let role = getTripMemberRole(tripId);
      return isSystemAdmin() || role == 'owner' || role == 'editor';
    }

    // 使用者資料集合
    match /users/{userId} {
      allow read: if isOwner(userId) || isAuthorizedUser();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'status']) || isSystemAdmin());
      allow delete: if isSystemAdmin();
    }

    // 系統設定集合
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isSystemAdmin();
    }

    // 旅程成員 Collection Group 查詢
    match /{path=**}/members/{memberId} {
      allow read: if isAuthorizedUser() && resource.data.userId == request.auth.uid;
    }

    // 旅程集合
    match /trips/{tripId} {
      // 讀取單一旅程：成員可讀
      allow read: if isAuthorizedUser() && isTripMember(tripId);
      // 系統管理者可讀取所有旅程 (list query)
      allow read: if isSystemAdmin();
      
      allow create: if isAuthorizedUser();
      allow update: if isTripMember(tripId) && canEditTrip(tripId);
      allow delete: if isSystemAdmin() || (isTripMember(tripId) && getTripMemberRole(tripId) == 'owner');

      match /members/{memberId} {
        allow read: if isAuthorizedUser() && isTripMember(tripId);
        allow create, update, delete: if isAuthorizedUser() && isTripMember(tripId) && getTripMemberRole(tripId) == 'owner';
      }

      match /expenses/{expenseId} {
        allow read: if isAuthorizedUser() && isTripMember(tripId);
        allow create: if isAuthorizedUser() && isTripMember(tripId) && canEditTrip(tripId);
        allow update, delete: if isAuthorizedUser() && isTripMember(tripId)
                              && (canEditTrip(tripId) || (request.auth.uid == resource.data.submittedBy && getTripMemberRole(tripId) != 'viewer'));
      }
    }

    // 分類集合
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin();
    }

    // 支付方式集合
    match /paymentMethods/{methodId} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin();
    }

    // 匯率快取集合
    match /exchangeRates/{rateId} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin();
    }

    // 幣別集合
    match /currencies/{currencyId} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin();
    }

    // 通知集合
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create, delete: if isSystemAdmin();
    }
  }
}