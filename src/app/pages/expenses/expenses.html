<div class="animate-fade-in-up pb-24">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6" *ngIf="trip$ | async as trip">
    <div class="flex items-center gap-4">
       <a routerLink="/trips" class="soft-btn-icon text-text-light">
         <fa-icon [icon]="faArrowLeft"></fa-icon>
       </a>
       <div>
         <h1 class="text-2xl font-bold text-text">{{ trip.name }}</h1>
         <p class="text-sm text-text-light" *ngIf="trip.startDate">
           {{ trip.startDate.toDate() | date:'yyyy/MM/dd' }} - {{ trip.endDate.toDate() | date:'yyyy/MM/dd' }}
         </p>
       </div>
    </div>
  </div>

  <!-- Expenses List -->
  <div class="space-y-4">
    @for (expense of expenses$ | async; track expense.id) {
      <div class="soft-card flex items-center justify-between p-4 group hover:bg-white/40 transition-colors relative">
        
        <div class="flex items-center gap-4 flex-1">
          <!-- Icon -->
          <div class="w-12 h-12 rounded-xl bg-surface shadow-soft-inset flex items-center justify-center text-primary text-xl flex-shrink-0 relative overflow-hidden">
             <!-- Show dynamic icon -->
             <fa-icon [icon]="getCategoryIcon(expense.category)"></fa-icon>
             
             <!-- If it's a fallback tag icon, overlay the first letter for custom categories -->
             @if (getCategoryIcon(expense.category).iconName === 'tag') {
               <span class="absolute inset-0 flex items-center justify-center text-[10px] font-black uppercase mt-1 opacity-40">
                 {{ expense.category.charAt(0) }}
               </span>
             }
          </div>
          
          <div class="min-w-0">
            <h3 class="font-bold text-text truncate pr-2">{{ expense.item }}</h3>
            <div class="flex flex-wrap items-center gap-2 text-xs text-text-light">
               <span>{{ expense.expenseDate.toDate() | date:'yyyy/MM/dd' }}</span>
               <span>•</span>
               <span>{{ expense.paymentMethod }}</span>
               <span *ngIf="expense.note" class="truncate max-w-[100px]">• {{ expense.note }}</span>
            </div>
          </div>
        </div>

        <div class="text-right flex-shrink-0">
          <div class="font-bold text-text">
            {{ expense.amountInTWD | number }} TWD
          </div>
          <div class="text-xs text-text-light" *ngIf="expense.currency !== 'TWD'">
             {{ expense.amount | number }} {{ expense.currency }}
          </div>
          
          <!-- Actions -->
          <div class="flex items-center justify-end gap-3 mt-2 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
            <button *ngIf="expense.receiptImageUrls?.length || expense.receiptImageUrl" 
                    (click)="viewReceipts(expense)" 
                    class="text-text-light hover:text-primary transition-colors" 
                    [title]="'查看照片 (' + ((expense.receiptImageUrls?.length) || 1) + ')'">
              <fa-icon [icon]="faImages"></fa-icon>
            </button>
            <button (click)="openEdit(expense)" class="text-text-light hover:text-primary transition-colors" title="編輯">
              <fa-icon [icon]="faEdit"></fa-icon>
            </button>
            <button (click)="delete(expense)" class="text-text-light hover:text-danger transition-colors" title="刪除">
              <fa-icon [icon]="faTrash"></fa-icon>
            </button>
          </div>
        </div>

      </div>
    } @empty {
      <div class="text-center py-20 text-text-light opacity-60 flex flex-col items-center">
        <div class="w-20 h-20 rounded-full bg-surface shadow-soft-inset flex items-center justify-center mb-4 text-3xl">
            <fa-icon [icon]="faReceipt"></fa-icon>
        </div>
        <p>尚無支出紀錄。</p>
        <p class="text-sm">點擊 + 按鈕新增一筆。</p>
      </div>
    }
  </div>

  <!-- FAB Add Button -->
  <button (click)="openAdd()" class="fixed bottom-8 right-8 w-16 h-16 rounded-full bg-primary text-white shadow-soft-lg flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition-transform z-40">
    <fa-icon [icon]="faPlus"></fa-icon>
  </button>

  <!-- Dialog -->
  <app-expense-dialog 
    *ngIf="showDialog" 
    [tripId]="tripId" 
    [tripCurrency]="(trip$ | async)?.currency || 'TWD'"
    [expense]="selectedExpense" 
    (close)="closeDialog()">
  </app-expense-dialog>
</div>