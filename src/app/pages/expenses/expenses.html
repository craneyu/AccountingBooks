<div class="animate-fade-in-up pb-24">
  <!-- 統計視圖 -->
  @if (showStatistics() && !isLoading()) {
    <div class="mb-6 border-b-2 border-gray-200 pb-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-800">統計與圖表</h2>
        <button (click)="closeStatistics()"
                class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors text-sm font-medium">
          關閉統計
        </button>
      </div>
      <app-statistics [expenses]="currentExpenses()"></app-statistics>
    </div>
  }

  <!-- 加載狀態 -->
  @if (isLoading()) {
    <div class="flex items-center justify-center py-20">
      <div class="text-center">
        <fa-icon [icon]="faReceipt" class="text-3xl text-primary mb-4 animate-spin"></fa-icon>
        <p class="text-text-light">載入中...</p>
      </div>
    </div>
  }

  <!-- Header -->
  @if (!isLoading() && (trip$ | async); as trip) {
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4 flex-1">
         <a routerLink="/trips" class="soft-btn-icon text-text-light">
           <fa-icon [icon]="faArrowLeft"></fa-icon>
         </a>
         <div class="flex-1">
           <h1 class="text-2xl font-bold text-text">{{ trip.name }}</h1>
           @if (trip.startDate) {
             <p class="text-sm text-text-light">
               {{ trip.startDate.toDate() | date:'yyyy/MM/dd' }} - {{ trip.endDate.toDate() | date:'yyyy/MM/dd' }}
             </p>
           }
         </div>
      </div>

      <!-- 按鈕群組 -->
      <div class="flex items-center gap-2">
        <!-- 搜尋篩選按鈕 -->
        <button (click)="openSearchFilter()"
                class="soft-btn-icon text-text-light hover:text-primary transition-colors relative"
                [class.text-primary]="hasActiveFilters()"
                title="搜尋與篩選">
          <fa-icon [icon]="faSearch"></fa-icon>
          @if (hasActiveFilters()) {
            <span class="absolute -top-1 -right-1 w-2 h-2 bg-primary rounded-full"></span>
          }
        </button>

        <!-- 統計按鈕 -->
        <button (click)="openStatistics()"
                class="soft-btn-icon text-text-light hover:text-primary transition-colors"
                title="查看統計">
          <fa-icon [icon]="faChartBar"></fa-icon>
        </button>

        <!-- 匯出按鈕下拉菜單 -->
        <div class="relative group">
          <button class="soft-btn-icon text-text-light hover:text-primary transition-colors"
                  title="匯出支出資料"
                  [disabled]="exporting()">
            <fa-icon [icon]="faDownload"></fa-icon>
          </button>
          <!-- 下拉菜單 -->
          <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-soft opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
            <button (click)="exportAsCSV()"
                    [disabled]="exporting()"
                    class="w-full text-left px-4 py-3 hover:bg-gray-100 transition-colors flex items-center gap-2 border-b border-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
              <fa-icon [icon]="faFileExcel" class="text-green-500"></fa-icon>
              <div>
                <p class="font-medium text-sm text-gray-800">匯出 CSV</p>
                <p class="text-xs text-gray-500">支出資料表格</p>
              </div>
            </button>
            <button (click)="exportAsZIP()"
                    [disabled]="exporting()"
                    class="w-full text-left px-4 py-3 hover:bg-gray-100 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
              <fa-icon [icon]="faFileZipper" class="text-blue-500"></fa-icon>
              <div>
                <p class="font-medium text-sm text-gray-800">匯出 ZIP</p>
                <p class="text-xs text-gray-500">資料 + 所有收據</p>
              </div>
            </button>
          </div>
        </div>

        <!-- 成員管理按鈕 -->
        <button (click)="openMembersDialog()"
                class="soft-btn-icon text-text-light hover:text-primary transition-colors"
                title="管理成員">
          <fa-icon [icon]="faUsers"></fa-icon>
        </button>
      </div>
    </div>
  }

  <!-- 篩選狀態提示 -->
  @if (!isLoading() && hasActiveFilters()) {
    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
      <div class="text-sm text-blue-800">
        <strong>篩選結果：</strong> 顯示 <strong>{{ filterStats().filteredExpenses }}</strong> 筆
        （共 <strong>{{ filterStats().totalExpenses }}</strong> 筆支出）
      </div>
      <button (click)="resetFilter()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
        清除篩選
      </button>
    </div>
  }

  <!-- Expenses List -->
  @if (!isLoading()) {
    <div class="space-y-4">
      @for (expense of filteredExpenses(); track expense.id) {
        <app-expense-item
          [expense]="expense"
          [canEdit]="canEditExpense(expense)"
          (viewReceipts)="viewReceipts($event)"
          (edit)="openEdit($event)"
          (delete)="delete($event)">
        </app-expense-item>
      } @empty {
        <div class="text-center py-20 text-text-light opacity-60 flex flex-col items-center">
          <div class="w-20 h-20 rounded-full bg-surface shadow-soft-inset flex items-center justify-center mb-4 text-3xl">
              <fa-icon [icon]="faReceipt"></fa-icon>
          </div>
          <p>尚無支出紀錄。</p>
          @if (canAddExpense()) {
            <p class="text-sm">點擊 + 按鈕新增一筆。</p>
          } @else {
            <p class="text-sm">您沒有權限新增支出。</p>
          }
        </div>
      }
    </div>
  }

  <!-- FAB Add Button -->
  @if (!isLoading() && canAddExpense()) {
    <button (click)="openAdd()" class="fixed bottom-8 right-8 w-16 h-16 rounded-full bg-primary text-white shadow-soft-lg flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition-transform z-40">
      <fa-icon [icon]="faPlus"></fa-icon>
    </button>
  }

  <!-- Dialog -->
  @if (showDialog) {
    <app-expense-dialog
      [tripId]="tripId"
      [tripCurrency]="(trip$ | async)?.currency || 'TWD'"
      [expense]="selectedExpense"
      (close)="closeDialog()">
    </app-expense-dialog>
  }

  <!-- Members Dialog -->
  @if (showMembersDialog()) {
    <app-trip-members-dialog
      [tripId]="tripId"
      [currentUserRole]="currentMemberRole()"
      (close)="closeMembersDialog()">
    </app-trip-members-dialog>
  }

  <!-- Search & Filter Panel -->
  @if (showSearchFilter()) {
    <app-search-filter
      [categories]="availableCategories()"
      [paymentMethods]="availablePaymentMethods()"
      [members]="availableMembers()"
      [currencies]="currencies"
      (filterApplied)="applyFilter($event)"
      (filterReset)="resetFilter()"
      (close)="closeSearchFilter()">
    </app-search-filter>
  }
</div>