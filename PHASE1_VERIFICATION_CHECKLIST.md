# Phase 1 é©—æ”¶æ¸…å–®ï¼šå®‰å…¨æ€§èˆ‡æ¬Šé™åŸºç¤

## æ¦‚è¿°

æœ¬æ–‡ä»¶æä¾› Phase 1 çš„å®Œæ•´é©—æ”¶æ¸…å–®ã€‚åœ¨é€²è¡Œ Phase 2 ä¹‹å‰ï¼Œè«‹ç¢ºä¿æ‰€æœ‰é …ç›®éƒ½å·²é€šéé©—è­‰ã€‚

## éƒ¨ç½²å‰æª¢æŸ¥

### âœ… Firestore è¦å‰‡æª”æ¡ˆ
- [ ] `firestore.rules` æª”æ¡ˆå­˜åœ¨
- [ ] åŒ…å«æ‰€æœ‰å¿…è¦çš„æ¬Šé™å‡½å¼ï¼š
  - [ ] `isAuthenticated()`
  - [ ] `isAuthorizedUser()`
  - [ ] `isSystemAdmin()`
  - [ ] `isTripMember(tripId)`
  - [ ] `getTripMemberRole(tripId)`
  - [ ] `canEditTrip(tripId)`
- [ ] åŒ…å«æ‰€æœ‰é›†åˆçš„è¦å‰‡ï¼š
  - [ ] `/users/*`
  - [ ] `/trips/*`
  - [ ] `/trips/{tripId}/members/*`
  - [ ] `/trips/{tripId}/expenses/*`
  - [ ] `/categories/*`
  - [ ] `/paymentMethods/*`
  - [ ] `/exchangeRates/*`
  - [ ] `/currencies/*`
  - [ ] `/notifications/*`

### âœ… Storage è¦å‰‡æª”æ¡ˆ
- [ ] `storage.rules` æª”æ¡ˆå­˜åœ¨
- [ ] åŒ…å«ä»¥ä¸‹è·¯å¾‘çš„è¦å‰‡ï¼š
  - [ ] `/receipts/{tripId}/*`
  - [ ] `/trip-covers/{tripId}/*`
  - [ ] `/avatars/{userId}/*`
- [ ] æ–‡ä»¶å¤§å°é™åˆ¶è¨­ç½®ç‚º 10MB
- [ ] å…§å®¹é¡å‹é©—è­‰åŒ…æ‹¬ JPEGã€PNGã€HEIC

### âœ… Firebase é…ç½®
- [ ] `firebase.json` åŒ…å«è¦å‰‡é…ç½®
- [ ] Firestore è¦å‰‡è·¯å¾‘æ­£ç¢º
- [ ] Storage è¦å‰‡è·¯å¾‘æ­£ç¢º
- [ ] å°ˆæ¡ˆ ID æ­£ç¢º

## ç¨‹å¼ç¢¼æª¢æŸ¥

### âœ… è·¯ç”±å®ˆè¡›
- [ ] `admin.guard.ts` æª”æ¡ˆå­˜åœ¨
- [ ] Guard æª¢æŸ¥ `isAdmin` æ¨™èªŒ
- [ ] Guard æª¢æŸ¥ `status === 'active'`
- [ ] é admin é‡å°å‘è‡³ `/trips`
- [ ] `app.routes.ts` ç‚º `/admin` è·¯ç”±å¥—ç”¨ `adminGuard`

### âœ… è³‡æ–™æ¨¡å‹
- [ ] `trip-member.model.ts` å®šç¾©
- [ ] `Trip` æ¨¡å‹åŒ…å«ï¼š
  - [ ] `ownerId?`: string
  - [ ] `memberCount?`: number
  - [ ] `customCurrencies?`: string[]
- [ ] `User` æ¨¡å‹åŒ…å«ï¼š
  - [ ] `deleteRequestedAt?`: Timestamp
  - [ ] `deletedAt?`: Timestamp
- [ ] `Expense` æ¨¡å‹åŒ…å«ï¼š
  - [ ] `isDeletedUser?`: boolean

### âœ… æœå‹™å±¤
- [ ] `TripMembersService` å¯¦ç¾ä»¥ä¸‹æ–¹æ³•ï¼š
  - [ ] `getTripMembers(tripId)`
  - [ ] `getTripMember(tripId, userId)`
  - [ ] `addMember(tripId, member)`
  - [ ] `addMemberWithUserId(tripId, userId, member)`
  - [ ] `updateMember(tripId, userId, data)`
  - [ ] `removeMember(tripId, userId)`
  - [ ] `checkMembership(tripId, userId)`
  - [ ] `getMemberRole(tripId, userId)`
  - [ ] `createMembersInBatch(tripId, members)`

### âœ… UI çµ„ä»¶
- [ ] `TripMembersDialogComponent` å¯¦ç¾ï¼š
  - [ ] é¡¯ç¤ºæˆå“¡åˆ—è¡¨
  - [ ] Owner å¯æ–°å¢æˆå“¡
  - [ ] Owner å¯æ›´æ–°æˆå“¡è§’è‰²
  - [ ] Owner å¯ç§»é™¤æˆå“¡
  - [ ] éŒ¯èª¤è™•ç†å’Œç”¨æˆ¶åé¥‹
- [ ] `ExpensesComponent` å¯¦ç¾ï¼š
  - [ ] æª¢æŸ¥æˆå“¡è³‡æ ¼
  - [ ] éæˆå“¡é‡å°å‘
  - [ ] æ¬Šé™æ§åˆ¶ç·¨è¼¯å’Œåˆªé™¤
  - [ ] æˆå“¡ç®¡ç†å°è©±æ¡†é›†æˆ
- [ ] `TripsComponent` å¯¦ç¾ï¼š
  - [ ] æˆå“¡ç®¡ç†æŒ‰éˆ•
  - [ ] æ¬Šé™æª¢æŸ¥åˆªé™¤æ“ä½œ
  - [ ] é admin ä¹Ÿå¯æ–°å¢æ—…ç¨‹
- [ ] `TripDialogComponent` å¯¦ç¾ï¼š
  - [ ] æ–°æ—…ç¨‹å»ºç«‹æ™‚è‡ªå‹•å»ºç«‹ owner member

## åŠŸèƒ½é©—è­‰

### âœ… Admin Guard åŠŸèƒ½

```
æ¸¬è©¦å ´æ™¯ 1ï¼šAdmin è¨ªå•ç®¡ç†å“¡è·¯ç”±
1. ä»¥ isAdmin=true çš„ä½¿ç”¨è€…ç™»å…¥
2. è¨ªå• /admin/dashboard
3. æ‡‰æˆåŠŸåŠ è¼‰é é¢
âœ“ é æœŸçµæœï¼šé é¢æ­£å¸¸é¡¯ç¤º

æ¸¬è©¦å ´æ™¯ 2ï¼šé Admin è¨ªå•ç®¡ç†å“¡è·¯ç”±
1. ä»¥ isAdmin=false çš„ä½¿ç”¨è€…ç™»å…¥
2. å˜—è©¦è¨ªå• /admin/dashboard
3. æ‡‰è¢«é‡å°å‘è‡³ /trips
âœ“ é æœŸçµæœï¼šé‡å°å‘è‡³ trips é é¢
```

### âœ… æˆå“¡æ¬Šé™åŠŸèƒ½

```
æ¸¬è©¦å ´æ™¯ 3ï¼šOwner ç®¡ç†æˆå“¡
1. ä»¥æ—…ç¨‹ owner èº«ä»½ç™»å…¥
2. é€²å…¥æ—…ç¨‹æ”¯å‡ºé é¢
3. é»æ“Šæˆå“¡ç®¡ç†æŒ‰éˆ•ï¼ˆğŸ‘¥ï¼‰
4. æ‡‰èƒ½çœ‹åˆ°æ–°å¢ã€ç·¨è¼¯ã€ç§»é™¤æˆå“¡çš„é¸é …
âœ“ é æœŸçµæœï¼šæˆå“¡ç®¡ç†å°è©±æ¡†æ­£ç¢ºé¡¯ç¤º

æ¸¬è©¦å ´æ™¯ 4ï¼šViewer ç„¡æ³•ç®¡ç†æˆå“¡
1. ä»¥æ—…ç¨‹ viewer èº«ä»½ç™»å…¥
2. é€²å…¥æ—…ç¨‹æ”¯å‡ºé é¢
3. é»æ“Šæˆå“¡ç®¡ç†æŒ‰éˆ•
4. æ‡‰é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
âœ“ é æœŸçµæœï¼šã€Œåªæœ‰æ—…ç¨‹æ‰€æœ‰è€…å¯ä»¥ç®¡ç†æˆå“¡ã€

æ¸¬è©¦å ´æ™¯ 5ï¼šéæˆå“¡ç„¡æ³•æŸ¥çœ‹æ—…ç¨‹
1. ä»¥éæˆå“¡ä½¿ç”¨è€…èº«ä»½ç™»å…¥
2. å˜—è©¦ç›´æ¥è¨ªå• /trip/{tripId}/expenses
3. æ‡‰è¢«é˜»æ­¢ä¸¦é‡å°å‘
âœ“ é æœŸçµæœï¼šé‡å°å‘è‡³ /trips
```

### âœ… æ¬Šé™æ§åˆ¶åŠŸèƒ½

```
æ¸¬è©¦å ´æ™¯ 6ï¼šEditor å¯ç·¨è¼¯æ”¯å‡º
1. ä»¥ editor èº«ä»½ç™»å…¥æ—…ç¨‹
2. æ‡‰èƒ½çœ‹åˆ°ç·¨è¼¯ï¼ˆâœï¸ï¼‰å’Œåˆªé™¤ï¼ˆğŸ—‘ï¸ï¼‰æŒ‰éˆ•
3. é»æ“Šç·¨è¼¯æ‡‰æ‰“é–‹ç·¨è¼¯å°è©±æ¡†
âœ“ é æœŸçµæœï¼šæˆåŠŸç·¨è¼¯æ”¯å‡º

æ¸¬è©¦å ´æ™¯ 7ï¼šViewer åªèƒ½æŸ¥çœ‹
1. ä»¥ viewer èº«ä»½ç™»å…¥æ—…ç¨‹
2. æ‡‰ä¸èƒ½çœ‹åˆ°ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•
3. æ–°å¢æŒ‰éˆ•ï¼ˆ+ï¼‰æ‡‰éš±è—
âœ“ é æœŸçµæœï¼šç•Œé¢æ­£ç¢ºéš±è—æ“ä½œæŒ‰éˆ•

æ¸¬è©¦å ´æ™¯ 8ï¼šæ”¯å‡ºæäº¤è€…æ¬Šé™
1. Viewer æäº¤æ”¯å‡º
2. è©² viewer æ‡‰èƒ½ç·¨è¼¯/åˆªé™¤è‡ªå·±çš„æ”¯å‡º
3. ä¸èƒ½ç·¨è¼¯ä»–äººçš„æ”¯å‡º
âœ“ é æœŸçµæœï¼šæ¬Šé™æ§åˆ¶æ­£ç¢º
```

### âœ… è³‡æ–™é·ç§»åŠŸèƒ½

```
æ¸¬è©¦å ´æ™¯ 9ï¼šåŸ·è¡Œè³‡æ–™é·ç§»
1. å‚™ä»½ Firestore è³‡æ–™åº«
2. é‹è¡Œï¼šnpx ts-node scripts/migrate-trip-members.ts
3. æª¢æŸ¥è¼¸å‡ºæ—¥èªŒ
4. é©—è­‰æ¯å€‹æ—…ç¨‹éƒ½æœ‰å°æ‡‰çš„ owner member
âœ“ é æœŸçµæœï¼šé·ç§»æˆåŠŸï¼Œç„¡éŒ¯èª¤

æ¸¬è©¦å ´æ™¯ 10ï¼šå†ªç­‰æ€§æª¢æŸ¥
1. å†æ¬¡é‹è¡Œé·ç§»è…³æœ¬
2. æ‡‰è·³éå·²é·ç§»çš„æ—…ç¨‹
âœ“ é æœŸçµæœï¼šè…³æœ¬å ±å‘Šã€Œå·²è·³éã€
```

## Firestore è¦å‰‡é©—è­‰

### ä½¿ç”¨ Firebase Emulator æ¸¬è©¦

```bash
# 1. å•Ÿå‹• Emulator
firebase emulators:start --only firestore,storage

# 2. åœ¨ç€è¦½å™¨æ‰“é–‹ Emulator UI
# http://localhost:4000
```

### è¦å‰‡æ¸¬è©¦å ´æ™¯

```
å ´æ™¯ Aï¼šéæˆæ¬Šä½¿ç”¨è€…ç„¡æ³•è®€å–æ—…ç¨‹
1. æœªç™»å…¥æˆ– status='inactive'
2. å˜—è©¦è®€å–ä»»ä½•æ—…ç¨‹
3. æ‡‰å¾—åˆ° permission-denied éŒ¯èª¤
âœ“ é æœŸçµæœï¼šè®€å–è¢«æ‹’çµ•

å ´æ™¯ Bï¼šéæˆå“¡ç„¡æ³•è®€å–æ—…ç¨‹
1. ä»¥æˆæ¬Šä½¿ç”¨è€…ç™»å…¥
2. å˜—è©¦è®€å–éè‡ªå·±çš„æ—…ç¨‹ï¼ˆéæˆå“¡ï¼‰
3. æ‡‰å¾—åˆ° permission-denied éŒ¯èª¤
âœ“ é æœŸçµæœï¼šè®€å–è¢«æ‹’çµ•

å ´æ™¯ Cï¼šæˆå“¡å¯è®€å–æ—…ç¨‹
1. ä»¥æˆå“¡èº«ä»½ç™»å…¥
2. è®€å–æ—…ç¨‹è³‡æ–™
3. æ‡‰æˆåŠŸè®€å–
âœ“ é æœŸçµæœï¼šè®€å–æˆåŠŸ

å ´æ™¯ Dï¼šViewer ç„¡æ³•å»ºç«‹æ”¯å‡º
1. ä»¥ viewer èº«ä»½ç™»å…¥
2. å˜—è©¦å»ºç«‹æ”¯å‡º
3. æ‡‰å¾—åˆ° permission-denied éŒ¯èª¤
âœ“ é æœŸçµæœï¼šå¯«å…¥è¢«æ‹’çµ•

å ´æ™¯ Eï¼šEditor å¯å»ºç«‹æ”¯å‡º
1. ä»¥ editor èº«ä»½ç™»å…¥
2. å»ºç«‹æ”¯å‡º
3. æ‡‰æˆåŠŸå»ºç«‹
âœ“ é æœŸçµæœï¼šå¯«å…¥æˆåŠŸ

å ´æ™¯ Fï¼šåªæœ‰ Owner å¯ç®¡ç†æˆå“¡
1. ä»¥ editor èº«ä»½å˜—è©¦æ–°å¢æˆå“¡
2. æ‡‰å¾—åˆ° permission-denied éŒ¯èª¤
3. ä»¥ owner èº«ä»½æ–°å¢æˆå“¡
4. æ‡‰æˆåŠŸ
âœ“ é æœŸçµæœï¼šæ¬Šé™æª¢æŸ¥æ­£ç¢º
```

## éƒ¨ç½²æª¢æŸ¥æ¸…å–®

### ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å‰

- [ ] æ‰€æœ‰æ¸¬è©¦éƒ½å·²é€šé
- [ ] Firestore è³‡æ–™åº«å·²å‚™ä»½
- [ ] è¦å‰‡èªæ³•å·²é©—è­‰ï¼š`firebase rules:test firestore.rules`
- [ ] åœ¨ Staging ç’°å¢ƒé€²è¡Œå®Œæ•´æ¸¬è©¦
- [ ] ç¢ºèªæ²’æœ‰ç·¨è­¯éŒ¯èª¤ï¼š`npm run build`
- [ ] æª¢æŸ¥ Firebase Console ä¸­çš„è¦å‰‡å’Œç´¢å¼•

### éƒ¨ç½²æ­¥é©Ÿ

```bash
# 1. ç™»å…¥ Firebase
firebase login

# 2. éƒ¨ç½²è¦å‰‡
firebase deploy --only firestore:rules,storage

# 3. é©—è­‰è¦å‰‡å·²éƒ¨ç½²
firebase rules:test firestore.rules

# 4. åŸ·è¡Œè³‡æ–™é·ç§»
npx ts-node scripts/migrate-trip-members.ts

# 5. é©—è­‰é·ç§»æˆåŠŸ
# åœ¨ Firebase Console ä¸­æª¢æŸ¥ trips/{tripId}/members é›†åˆ
```

### éƒ¨ç½²å¾Œé©—è­‰

- [ ] Admin Guard æ­£å¸¸é‹ä½œ
- [ ] æˆå“¡ç®¡ç†åŠŸèƒ½å¯ç”¨
- [ ] éæˆå“¡ç„¡æ³•è¨ªå•æ—…ç¨‹
- [ ] æ¬Šé™æ§åˆ¶ç”Ÿæ•ˆ
- [ ] æ²’æœ‰ Firebase è¦å‰‡é•åéŒ¯èª¤
- [ ] ç”¨æˆ¶å¯æ­£å¸¸æ–°å¢æ”¯å‡ºï¼ˆå¦‚æœ‰æ¬Šé™ï¼‰

## å¸¸è¦‹å•é¡Œè§£æ±º

### è¦å‰‡éƒ¨ç½²å¤±æ•—

**ç—‡ç‹€**ï¼š`Error: PERMISSION_DENIED`

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª Firebase å¸³æˆ¶æœ‰é©ç•¶æ¬Šé™
2. æª¢æŸ¥ `.firebaserc` ä¸­çš„é …ç›® ID
3. é©—è­‰è¦å‰‡èªæ³•

```bash
firebase rules:test firestore.rules --database=default
```

### è³‡æ–™é·ç§»å¤±æ•—

**ç—‡ç‹€**ï¼šæ‰¾ä¸åˆ° service account key

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. å¾ Firebase Console ä¸‹è¼‰ service account key
2. æ”¾ç½®åœ¨é …ç›®æ ¹ç›®éŒ„ï¼Œå‘½åç‚º `service-account-key.json`
3. ç¢ºèªæª”æ¡ˆæ¬Šé™ï¼š`chmod 600 service-account-key.json`

### æˆå“¡ç®¡ç†å°è©±æ¡†ç„¡æ³•åŠ è¼‰

**ç—‡ç‹€**ï¼šæˆå“¡åˆ—è¡¨ç‚ºç©ºæˆ–é¡¯ç¤ºéŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª Firestore è¦å‰‡å·²éƒ¨ç½²
2. æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°éŒ¯èª¤
3. é©—è­‰ `trips/{tripId}/members` é›†åˆä¸­æœ‰æ–‡ä»¶
4. ç¢ºèªä½¿ç”¨è€…æ˜¯æ—…ç¨‹æˆå“¡

## ç°½ç½²ç¢ºèª

éƒ¨ç½²è€…ç°½ç½²ç¢ºèªå·²å®Œæˆæ‰€æœ‰é©—æ”¶é …ç›®ï¼š

| é …ç›® | ç‹€æ…‹ | é©—è­‰æ—¥æœŸ | ç°½ç½² |
|------|------|---------|------|
| è¦å‰‡æª”æ¡ˆæª¢æŸ¥ | âœ“ | | |
| ç¨‹å¼ç¢¼æª¢æŸ¥ | âœ“ | | |
| åŠŸèƒ½é©—è­‰ | âœ“ | | |
| è¦å‰‡æ¸¬è©¦ | âœ“ | | |
| ç”Ÿç”¢éƒ¨ç½² | âœ“ | | |

## å¾ŒçºŒæ­¥é©Ÿ

Phase 1 å®Œæˆå¾Œï¼Œå¯é€²è¡Œä»¥ä¸‹å·¥ä½œï¼š

1. **Phase 2 - æ ¸å¿ƒåŠŸèƒ½æ“´å……**ï¼ˆ3-4 é€±ï¼‰
   - å¹£åˆ¥ç®¡ç†ç³»çµ±
   - æ™‚é–“é©—è­‰
   - çµ±è¨ˆèˆ‡åœ–è¡¨

2. **ç›£æ§å’Œç¶­è­·**
   - ç›£æ§ Firebase è¦å‰‡ä½¿ç”¨æƒ…æ³
   - æª¢æŸ¥éŒ¯èª¤æ—¥èªŒ
   - æ”¶é›†ä½¿ç”¨è€…åé¥‹

3. **æ–‡ä»¶æ›´æ–°**
   - æ›´æ–° README.md
   - è£½ä½œä½¿ç”¨è€…æ•™ç¨‹
   - å»ºç«‹ç®¡ç†å“¡æŒ‡å—

## ç›¸é—œè³‡æº

- Firestore å®‰å…¨è¦å‰‡ï¼šhttps://firebase.google.com/docs/firestore/security/
- Firebase Admin SDKï¼šhttps://firebase.google.com/docs/database/admin/start
- å°ˆæ¡ˆè¦ç¯„ï¼š`SPEC.md`
- éƒ¨ç½²æŒ‡å—ï¼š`PHASE1_DEPLOYMENT.md`
- å¯¦æ–½ç¸½çµï¼š`PHASE1_IMPLEMENTATION_SUMMARY.md`

---

**æ¸…å–®ç‰ˆæœ¬**ï¼š1.0
**æ›´æ–°æ—¥æœŸ**ï¼š2026-01-23
**ç‹€æ…‹**ï¼šæº–å‚™å¥½é€²è¡Œ Phase 2
